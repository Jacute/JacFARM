package rabbitmq

import (
	"exploit_runner/internal/config"
	"fmt"

	amqp "github.com/rabbitmq/amqp091-go"
)

const flagsQueueName = "flags"

type Rabbit struct {
	conn    *amqp.Connection
	writeCh *amqp.Channel
}

func New(cfg *config.RabbitMQConfig) *Rabbit {
	conn, err := amqp.Dial(fmt.Sprintf(
		"amqp://%s:%s@%s:%d/",
		cfg.Username,
		cfg.Password,
		cfg.Host,
		cfg.Port,
	))
	if err != nil {
		panic("failed to connect to RabbitMQ: " + err.Error())
	}
	writeCh, err := conn.Channel()
	if err != nil {
		panic("failed to create rabbitmq channel: " + err.Error())
	}
	return &Rabbit{
		conn:    conn,
		writeCh: writeCh,
	}
}

func (r *Rabbit) Close() error {
	if err := r.writeCh.Close(); err != nil {
		return fmt.Errorf("error closing channel %v", err)
	}
	if err := r.conn.Close(); err != nil {
		return fmt.Errorf("error closing conn %v", err)
	}
	return nil
}
