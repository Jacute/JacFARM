package exploit_runner

import (
	"context"
	"exploit_runner/internal/models"
	"exploit_runner/pkg/common_config"
	"log/slog"
	"regexp"
	"strconv"
	"time"

	"github.com/jacute/prettylogger"
)

type config struct {
	teams                 []*models.Team
	flagFormatRegexp      *regexp.Regexp
	exploitRunDuration    time.Duration
	exploitMaxWorkingTime time.Duration
	maxConcurrentExploits int
	exploitDirectory      string
}

func (er *ExploitRunner) loadConfig(ctx context.Context) error {
	const op = "service.exploit_runner.loadConfig"
	log := er.log.With(slog.String("op", op))

	flagFormat, err := er.db.GetConfigParameter(ctx, common_config.ConfigFlagFormatKey)
	if err != nil {
		log.Error(
			"error getting flag format from db config",
			slog.String("config_key", common_config.ConfigFlagFormatKey),
			prettylogger.Err(err),
		)
		return err
	}
	flagFormatRegexp, err := regexp.Compile(flagFormat)
	if err != nil {
		log.Error(
			"error compiling flag format regexp",
			slog.String("flag_format", flagFormat),
			prettylogger.Err(err),
		)
		return err
	}

	teams, err := er.db.GetTeams(ctx)
	if err != nil {
		log.Error(
			"error getting teams from db config",
			prettylogger.Err(err),
		)
		return err
	}

	exploitDurationStr, err := er.db.GetConfigParameter(ctx, common_config.ConfigExploitDuration)
	if err != nil {
		log.Error(
			"error getting exploit run duration from db config",
			slog.String("config_key", common_config.ConfigExploitDuration),
			prettylogger.Err(err),
		)
		return err
	}
	exploitDuration, err := time.ParseDuration(exploitDurationStr)
	if err != nil {
		log.Error(
			"error parsing exploit duration",
			slog.String("value_to_parse", exploitDurationStr),
			prettylogger.Err(err),
		)
		return err
	}

	maxConcurrentExploitsStr, err := er.db.GetConfigParameter(ctx, common_config.ConfigMaxConcurrentExploits)
	if err != nil {
		log.Error(
			"error getting max concurrent exploits from db config",
			slog.String("config_key", common_config.ConfigMaxConcurrentExploits),
			prettylogger.Err(err),
		)
		return err
	}
	maxConcurrentExploits, err := strconv.Atoi(maxConcurrentExploitsStr)
	if err != nil {
		log.Error(
			"error parsing max concurrent exploits",
			slog.String("value_to_parse", maxConcurrentExploitsStr),
			prettylogger.Err(err),
		)
		return err
	}

	exploitMaxWorkingTimeStr, err := er.db.GetConfigParameter(ctx, common_config.ConfigExploitMaxWorkingTime)
	if err != nil {
		log.Error(
			"error getting exploit max working time from db config",
			slog.String("config_key", common_config.ConfigExploitMaxWorkingTime),
			prettylogger.Err(err),
		)
		return err
	}
	exploitMaxWorkingTime, err := time.ParseDuration(exploitMaxWorkingTimeStr)
	if err != nil {
		log.Error(
			"error parsing exploit max working time",
			slog.String("value_to_parse", exploitMaxWorkingTimeStr),
			prettylogger.Err(err),
		)
		return err
	}

	er.cfg.exploitRunDuration = exploitDuration
	er.cfg.teams = teams
	er.cfg.flagFormatRegexp = flagFormatRegexp
	er.cfg.maxConcurrentExploits = maxConcurrentExploits
	er.cfg.exploitMaxWorkingTime = exploitMaxWorkingTime
	er.exploitSemaphore = make(chan struct{}, maxConcurrentExploits)

	return nil
}
