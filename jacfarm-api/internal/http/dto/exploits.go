package dto

import (
	"JacFARM/internal/models"
	"fmt"
	"strconv"

	"github.com/gabriel-vasile/mimetype"
)

type ListExploitsFilter struct {
	Limit uint64
	Page  uint64
}

type ListExploitsResponse struct {
	*Response
	Exploits []*models.Exploit `json:"exploits"`
}

type ListShortExploitsResponse struct {
	*Response
	Exploits []*models.ExploitShort `json:"exploits"`
}

func MapQueryToGetExploitsFilter(queries map[string]string) (*ListExploitsFilter, error) {
	var limit int
	limitStr, ok := queries["limit"]
	if ok && limitStr != "" {
		var err error
		limit, err = strconv.Atoi(limitStr)
		if err != nil {
			return nil, fmt.Errorf("limit should be number")
		}
	}
	if limit < 0 {
		return nil, fmt.Errorf("limit should be positive number")
	}

	var page int
	pageStr, ok := queries["page"]
	if ok && pageStr != "" {
		var err error
		page, err = strconv.Atoi(pageStr)
		if err != nil {
			return nil, fmt.Errorf("page should be number")
		}
	}
	if page < 0 {
		return nil, fmt.Errorf("page should be positive number")
	}

	return &ListExploitsFilter{
		Limit: uint64(limit),
		Page:  uint64(page),
	}, nil
}

type ToggleExploitResponse struct {
	*Response
	IsRunning bool `json:"is_running"`
}

type UploadExploitRequest struct {
	File             []byte
	RequirementsFile []byte
	Name             string
	Type             models.ExploitType
}

type UploadExploitResponse struct {
	*Response
	ID string `json:"id"`
}

func (req *UploadExploitRequest) Validate() error {
	if len(req.Name) > 100 {
		return fmt.Errorf("name should be shorter than 100 characters")
	}
	if req.Type != models.ExploitTypeBash && req.Type != models.ExploitTypeBinary && req.Type != models.ExploitTypePython {
		return fmt.Errorf("incorrect field 'type'")
	}

	if req.Type == models.ExploitTypePython && req.File != nil {
		reqKind := mimetype.Detect(req.RequirementsFile)
		if !reqKind.Is("text/plain") {
			return fmt.Errorf("'requirements_file' has incorrect mime type")
		}
	}

	kind := mimetype.Detect(req.File)
	if kind.Is("application/x-executable") && req.Type == models.ExploitTypeBinary {
		return nil
	}
	if kind.Is("text/plain") && (req.Type == models.ExploitTypeBash || req.Type == models.ExploitTypePython) {
		return nil
	}

	return fmt.Errorf("'file' doesn't match 'type'")
}
