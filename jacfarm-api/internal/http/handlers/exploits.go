package handlers

import (
	"JacFARM/internal/http/dto"
	"JacFARM/internal/storage"
	"errors"
	"slices"

	"github.com/gofiber/fiber/v3"
	"github.com/google/uuid"
)

func (h *Handlers) ListExploits() func(c fiber.Ctx) error {
	return func(c fiber.Ctx) error {
		filter, err := dto.MapQueryToGetExploitsFilter(c.Queries())
		if err != nil {
			return c.JSON(dto.Error(err.Error()))
		}

		exploits, err := h.service.ListExploits(c.RequestCtx(), filter)
		if err != nil {
			return c.JSON(dto.ErrInternal)
		}

		return c.JSON(dto.ListExploitsResponse{
			Response: dto.OK(),
			Exploits: exploits,
		})
	}
}

func (h *Handlers) UploadExploit() func(c fiber.Ctx) error {
	return func(c fiber.Ctx) error {
		if !slices.Contains(c.GetReqHeaders()["Content-Type"], "application/json") {
			return c.JSON(dto.ErrInvalidContentType)
		}

		var req dto.UploadExploitRequest
		if err := c.Bind().Body(&req); err != nil {
			return c.JSON(dto.ErrDecodingBody)
		}

		decodedReq, err := dto.UploadExploitDecode(&req)
		if err != nil {
			return c.JSON(dto.Error(err.Error()))
		}

		if err := decodedReq.Validate(); err != nil {
			return c.JSON(dto.Error(err.Error()))
		}

		id, err := h.service.UploadExploit(c.RequestCtx(), decodedReq)
		if err != nil {
			c.JSON(dto.ErrInternal)
		}

		return c.JSON(dto.UploadExploitResponse{
			Response: dto.OK(),
			ID:       id,
		})
	}
}

func (h *Handlers) ToggleExploit() func(c fiber.Ctx) error {
	return func(c fiber.Ctx) error {
		id := c.Params("id")
		_, err := uuid.Parse(id)
		if err != nil {
			return c.JSON(dto.Error("id should be uuid"))
		}

		isRunning, err := h.service.ToggleExploit(c.RequestCtx(), id)
		if err != nil {
			if errors.Is(err, storage.ErrExploitNotFound) {
				return c.JSON(dto.Error(err.Error()))
			}
			return c.JSON(dto.ErrInternal)
		}

		return c.JSON(dto.ToggleExploitResponse{
			Response:  dto.OK(),
			IsRunning: isRunning,
		})
	}
}
