import { useCallback, useState } from "react";
import { ExploitTable } from "../components/exploits/Table";
import { AddModal } from "../components/exploits/AddModal";
import { Paginator } from "../components/Paginator";
import { Modal } from "../components/Modal";
import { getExploits } from "../api/exploits";
import type { Exploit } from "../models/models";
import { toast } from "react-toastify";
import { Spinner } from "../components/common/Spinner";


export const ExploitsPage = () => {
    const [page, setPage] = useState<number>(1);
    const [count, setCount] = useState<number>(0);
    const [exploits, setExploits] = useState<Array<Exploit>>([]);
    const [isLoading, setIsLoading] = useState<boolean>(false);

    const loadExploits = useCallback(async () => {
        setIsLoading(true);
        try {
            const { exploits, count } = await getExploits(page);
            setCount(count);
            setExploits(exploits);
        } catch (error: any) {
            toast.error(`Error loading exploits: ${error.message}`);
        } finally {
            setIsLoading(false);
        }
    }, [page, setCount]);

    return (
        <>
            <div className="row h-10 bg-primary border-bottom border-1 border-secondary">
                <div className="col-11"></div>
                <div className="col-1 d-flex align-items-center justify-content-center">
                    <button className='btn btn-white w-50 border border-1' data-bs-toggle="modal" data-bs-target="#modal">
                    ➕
                    </button>
                </div>
            </div>
            <div className="row h-90">
                <div className="d-flex flex-column h-100">
                    <div className="row flex-grow-1 overflow-auto position-relative">
                        {isLoading && <Spinner></Spinner>}
                        
                        <ExploitTable page={page} setExploits={setExploits} loadExploits={loadExploits} exploits={exploits} />
                    </div>

                    <div className="row mt-auto mx-auto">
                        <div className="col">
                            <Paginator page={page} setPage={setPage} count={count}/>
                        </div>
                    </div>
                </div>
            </div>
            <Modal title="Добавить эксплойт" ModalBody={<AddModal loadExploits={loadExploits}/>}/>
        </>
    )
}