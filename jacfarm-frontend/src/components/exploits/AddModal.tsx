import { useState } from "react";
import { toast } from "react-toastify";
import { uploadExploit } from "../../api/exploits";

interface props {
    loadExploits: () => void
}

export const AddModal = (props: props) => {
    const [name, setName] = useState<string>("");
    const [type, setType] = useState<string>("python");
    const [executableFile, setExecutableFile] = useState<File | null>(null);
    const [requirementsFile, setRequirementsFile] = useState<File | null>(null);

    const handleSubmit = async () => {
        if (!executableFile) return;
        try {
            await uploadExploit(executableFile, requirementsFile, name, type);
        } catch (error: any) {
            toast.error(`Error sending data: ${error.message}`);
        }
        props.loadExploits();
    }

    const handleExecutableChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            setExecutableFile(e.target.files[0]);
        }
    };

    const handleRequirementsChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            setRequirementsFile(e.target.files[0]);
        }
    };

    return (
        <>
            <div className="modal-body d-flex flex-column gap-3">
                {/* Поле для названия */}
                <div>
                    <label htmlFor="name" className="form-label">Exploit name</label>
                    <input
                        type="text"
                        id="name"
                        className="form-control"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        placeholder="Write exploit name"
                    />
                </div>

                {/* Выбор типа */}
                <div>
                    <label htmlFor="type" className="form-label">Exploit type</label>
                    <select
                        id="type"
                        className="form-select"
                        value={type}
                        onChange={(e) => setType(e.target.value)}
                    >
                        <option value="python">Python</option>
                        <option value="binary">Binary</option>
                        <option value="bash">Bash</option>
                        <option value="python_zip">Python (ZIP)</option>
                    </select>
                </div>

                {/* Загрузка исполняемого файла */}
                <div>
                    <label htmlFor="executable" className="form-label">
                        {type === "python" ? "Python file" : 
                         type === "binary" ? "Binary file" :
                         type === "python_zip" ? "ZIP file with main.py and requirements.txt" : "Bash script"}
                    </label>
                    <input
                        type="file"
                        id="executable"
                        className="form-control"
                        onChange={handleExecutableChange}
                        accept={type === "python" ? ".py" : 
                               type === "binary" ? "" :
                               type === "python_zip" ? ".zip" : ".sh"}
                    />
                </div>

                {/* Загрузка requirements.txt только для Python */}
                {type === "python" && (
                    <div>
                        <label htmlFor="requirements" className="form-label">
                            requirements.txt (optionally)
                        </label>
                        <input
                            type="file"
                            id="requirements"
                            className="form-control"
                            onChange={handleRequirementsChange}
                            accept=".txt"
                        />
                    </div>
                )}
            </div>
            <div className="modal-footer">
                <button type="button" className="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" className="btn btn-primary" data-bs-dismiss="modal" onClick={handleSubmit}>
                    Save
                </button>
            </div>
        </>
    )
}